"use strict";(self["webpackChunkmvtime"]=self["webpackChunkmvtime"]||[]).push([[747],{2747:function(e,a,s){s.r(a),s.d(a,{default:function(){return Z}});var t=s(6768),l=s(4232),i=s(5130);const n=e=>((0,t.Qi)("data-v-1befa0bc"),e=e(),(0,t.jt)(),e),o={class:"logdebug"},c={class:"admin_actions admin_in"},d=n((()=>(0,t.Lk)("h3",null,"Admin Actions",-1))),h={class:"action_buttons"},r=["disabled"],u={class:"docs_wrapper"},g={key:0,class:"docs_nav admin_in"},_=["disabled"],p=["title"],m=["disabled"],k={class:"docs_nav__loaded"},b={key:0},v={key:1},C=["disabled"],y={key:1,class:"docs"},f=["onClick"],w=["title"],$={key:0,class:"doc_title"},L=["href","onClick"],x={class:"doc_title__email_user"},E={class:"doc_title__email_domain"},M={class:"doc_title__ref"},R={class:"doc_title__time"},X={key:1,class:"doc_details"},D={class:"doc_details_table"},Q=n((()=>(0,t.Lk)("th",null,"Email:",-1))),q=["href","onClick"],A=n((()=>(0,t.Lk)("th",null,"User:",-1))),N=n((()=>(0,t.Lk)("th",null,"Date:",-1))),P=n((()=>(0,t.Lk)("th",null,"Ref:",-1))),z=["onClick"],G={key:2,class:"docs_placeholder docs_placeholder__empty"},T={key:3,class:"docs_placeholder docs_placeholder__loading"},F=n((()=>(0,t.Lk)("i",null,"Loading logs",-1))),U=[F];function I(e,a,s,n,F,I){const J=(0,t.g2)("Modal"),S=(0,t.g2)("OverlayWrapper");return(0,t.uX)(),(0,t.CE)("div",o,[F.showRebuildModal?((0,t.uX)(),(0,t.Wv)(S,{key:0,onClose:a[0]||(a[0]=e=>F.showRebuildModal=!1)},{default:(0,t.k6)((e=>[(0,t.bF)(J,{class:"confirm_modal router_center_view",can_continue:!0,title:"Rebuild Class Task Caches",html:"<div class='overlay_contents_text'>Are you sure you want to rebuild all class task caches?<br><br>This action will regenerate cached task data for all classes and may take a while to complete.</div>",continue_action:()=>I.confirmRebuildCaches(),skippable:!0,onSkip:e.close,skip_text:"Cancel",submit_text:"Rebuild Caches"},null,8,["continue_action","onSkip"])])),_:1})):(0,t.Q3)("",!0),(0,t.Lk)("div",c,[d,(0,t.Lk)("div",h,[(0,t.Lk)("button",{class:(0,l.C4)(["action_button",{loading_bg:F.rebuildingCache}]),disabled:F.rebuildingCache,onClick:a[1]||(a[1]=e=>F.showRebuildModal=!0)},"Rebuild Class Task Caches",10,r)])]),(0,t.Lk)("div",u,[F.pages.length?((0,t.uX)(),(0,t.CE)("nav",g,[(0,t.Lk)("button",{class:"docs_nav_button prev",onClick:a[2]||(a[2]=(...e)=>I.prev&&I.prev(...e)),disabled:!(I.total.length||F.pages.length)||!F.page_index,title:"Previous Page"},null,8,_),(0,t.bo)((0,t.Lk)("input",{type:"text","onUpdate:modelValue":a[3]||(a[3]=e=>F.search=e),class:"docs_nav_search",placeholder:"Search Log Reference, User ID, or Email",enterkeyhint:"search",onKeydown:a[4]||(a[4]=(0,i.jR)(((...e)=>I.submit&&I.submit(...e)),["enter"]))},null,544),[[i.Jo,F.search]]),I.manual&&F.loaded&&F.loaded==F.search?((0,t.uX)(),(0,t.CE)("button",{key:0,class:(0,l.C4)(["docs_nav_button clear",{click_escape:null==F.active}]),onClick:a[5]||(a[5]=(...e)=>I.clear&&I.clear(...e)),title:`Clear query '${this.loaded}'`},null,10,p)):F.search?((0,t.uX)(),(0,t.CE)("button",{key:1,class:(0,l.C4)(["docs_nav_button search",{click_ctrlenter:null==F.active&&!(F.search.length<10&&!F.search.includes("@")||F.search.length>100)}]),disabled:F.search.length<10&&!F.search.includes("@")||F.search.length>100,onClick:a[6]||(a[6]=(...e)=>I.submit&&I.submit(...e)),title:"Submit query (10+ characters or user email)"},null,10,m)):(0,t.Q3)("",!0),(0,t.Lk)("div",k,[I.manual?((0,t.uX)(),(0,t.CE)("span",b,(0,l.v_)(F.manual_page.length)+" Result"+(0,l.v_)(1==F.manual_page.length?"":"s"),1)):((0,t.uX)(),(0,t.CE)("span",v,(0,l.v_)(I.total.length+(I.more&&F.pages.length&&F.pages[F.pages.length-1].length&&F.pages[F.pages.length-1].length==F.page_size?"+":""))+" Result"+(0,l.v_)(1==I.total.length?"":"s"),1))]),I.manual&&F.search?(0,t.Q3)("",!0):((0,t.uX)(),(0,t.CE)("button",{key:2,class:"docs_nav_button next",onClick:a[7]||(a[7]=(...e)=>I.next&&I.next(...e)),disabled:!(I.total.length||F.pages.length)||!I.more,title:"Next Page"},null,8,C))])):(0,t.Q3)("",!0),F.pages.length&&I.total.length?((0,t.uX)(),(0,t.CE)("div",y,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(I.page,((e,a)=>((0,t.uX)(),(0,t.CE)("div",{class:(0,l.C4)(["doc admin_in",{active:F.active==e.id}]),key:e.id,style:(0,l.Tr)({animationDelay:.03*(a+2)+"s"})},[(0,t.Lk)("button",{class:(0,l.C4)(["doc_details__toggle",{click_escape:F.active==e.id}]),onClick:a=>F.active=F.active==e.id?null:e.id,title:"Close details pane"},[(0,t.Lk)("div",{class:"doc_details__toggle__icon themed_icon",title:`${F.active==e.id?"Collapse":"Expand"} log ${e.id}`},null,8,w)],10,f),F.active!=e.id?((0,t.uX)(),(0,t.CE)("div",$,[(0,t.Lk)("a",{class:"doc_title__email",href:`./logs?search=${e.data().email}`,onClick:a=>{F.search&&F.loaded==F.search||(F.search=e.data().email,I.submit()),a.preventDefault()}},[(0,t.Lk)("span",x,(0,l.v_)(e.data().email.split("@")[0]),1),(0,t.Lk)("span",E,"@"+(0,l.v_)(e.data().email.split("@")[1]),1)],8,L),(0,t.Lk)("span",M,(0,l.v_)(e.id),1),(0,t.Lk)("span",R,(0,l.v_)(e.data().date.toDate().getTime()),1)])):((0,t.uX)(),(0,t.CE)("div",X,[(0,t.Lk)("table",D,[(0,t.Lk)("tr",null,[Q,(0,t.Lk)("td",null,[(0,t.Lk)("a",{class:"doc_title__email",href:`./logs?search=${e.data().email}`,onClick:a=>{F.search&&F.loaded==F.search||(F.search=e.data().email,I.submit()),a.preventDefault()}},(0,l.v_)(e.data().email),9,q)])]),(0,t.Lk)("tr",null,[A,(0,t.Lk)("td",null,(0,l.v_)(e.data().user),1)]),(0,t.Lk)("tr",null,[N,(0,t.Lk)("td",null,(0,l.v_)(e.data().date.toDate()),1)]),(0,t.Lk)("tr",null,[P,(0,t.Lk)("td",null,(0,l.v_)(e.id),1)])]),(0,t.Lk)("button",{class:"doc_save click_ctrlenter",onClick:a=>I.downloadLogData(e.data().stream.json,e.data().date.toDate(),`cloud-${e.data().email}-${e.data().user}`)},"Download",8,z)]))],6)))),128))])):!I.total.length&&F.pages.length?((0,t.uX)(),(0,t.CE)("div",G,"No logs to display")):((0,t.uX)(),(0,t.CE)("div",T,U))])])}s(4114);var J=s(7617),S=s(6669),Y=s(9218),j=s(6301),W=s(4186),B=s(4411),H=s(4618),K={components:{OverlayWrapper:B.A,Modal:H.A},data(){return{active:null,page_index:0,page_size:10,pages:[],search:"",loaded:"",manual_page:[],rebuildingCache:!1,showRebuildModal:!1}},computed:{page(){return this.manual?this.manual_page:this.pages[this.page_index]},total(){return this.pages.flat(1)},more(){return!this.page||this.page.length===this.page_size&&(this.page_index==this.pages.length-1||this.pages[this.page_index+1]?.length)},shortcuts(){return[{key:"Enter",description:"Submit search"},{key:"Ctrl + Enter",description:"Download active log",top:!0},{key:"Escape",description:"Collapse active log, clear search",top:!0}]},manual(){return this.loaded&&this.manual_page.length}},async mounted(){this.$shortcuts.register_all(this.shortcuts,"Admin - Logs & Debugging"),this.$route.query.search&&(this.search=this.$route.query.search,this.submit()),await this.init()},beforeUnmount(){this.$shortcuts.remove_tag("Admin - Logs & Debugging")},methods:{confirmRebuildCaches(){this.showRebuildModal=!1,this.rebuildClassTaskCaches()},async rebuildClassTaskCaches(){if(!this.rebuildingCache){this.rebuildingCache=!0;try{const e=(0,Y.Qg)(S.Cn,"rebuildClassTaskCaches"),a=await e({}),s=a.data;if(s.error)throw new Error(s.error);new W.rQ(`Rebuilt ${s.classesUpdated} classes with ${s.tasksProcessed} tasks`,5e3),this.$status.log(`üîÑ Cache rebuild complete: ${s.classesUpdated} classes, ${s.tasksProcessed} tasks`)}catch(e){new W.Qp("Failed to rebuild caches",e,5e3),this.$status.error("üîÑ Cache rebuild failed:",e)}finally{this.rebuildingCache=!1}}},async init(){const e=(0,J.P)((0,J.rJ)(S.db,"logs"),(0,J.My)("date_inversed"),(0,J.AB)(this.page_size)),a=await(0,J.GG)(e);this.pages=[[...a.docs]],this.$status.log(`üìú Loaded first ${this.page_size} documents`)},downloadLogData:j.Fi,prev(){this.page_index>0&&this.page_index--},async next(){if(this.page_index<this.pages.length-1&&this.pages[this.page_index+1].length)this.page_index++;else if(this.page.length&&this.page.length===this.page_size){const e=(0,J.P)((0,J.rJ)(S.db,"logs"),(0,J.My)("date_inversed"),(0,J.HM)(this.page[this.page.length-1]),(0,J.AB)(this.page_size)),a=await(0,J.GG)(e);this.pages[this.page_index+1]=[...a.docs],this.$status.log(`üìú Loaded next ${a.docs.length} of ${this.page_size} documents`),this.next()}else this.$status.log(`üìú No more documents to load (${this.total.length} loaded)`)},clear(){this.search="",this.loaded="",this.manual_page=[],this.$router.push({query:{...this.$route.query,search:void 0}})},async submit(){if(this.active=null,this.search.includes("@")){const e=await(0,J.GG)((0,J.P)((0,J.rJ)(S.db,"logs"),(0,J._M)("email","==",this.search),(0,J.My)("date_inversed")));e.docs.length?(this.manual_page=[...e.docs],new W.rQ(`Found ${e.docs.length} log${1==e.docs.length?"":"s"} with email ${this.search}`,3500)):(this.$status.warn(`üîç No logs found with email <${this.search}>`),new W.MY("No logs found with that email address",3500),this.clear())}else if(this.search.length>=10){const e=await(0,J.x7)((0,J.H9)(S.db,"logs",this.search));if(e.exists())this.manual_page=[e],new W.rQ(`Found log with reference ${this.search}`,3500);else{this.$status.warn(`üîç No logs found with reference <${this.search}>, searching for matching user`),new W.MY("No logs found with that reference, checking for matching users",3500);const e=await(0,J.GG)((0,J.P)((0,J.rJ)(S.db,"logs"),(0,J._M)("user","==",this.search),(0,J.My)("date_inversed")));e.docs.length?(this.manual_page=[...e.docs],new W.rQ(`Found ${e.docs.length} log${1==e.docs.length?"":"s"} with user ${this.search}`,3500)):(this.$status.warn(`üîç No logs found with user <${this.search}>`),new W.MY("No logs found with that user id or reference",3500),this.clear())}}else this.$status.warn("üîç Invalid search query for logs"),new W.MY("Invalid search query for logs, must be 10+ characters or email",3500);this.loaded=this.search,this.$router.push({query:{...this.$route.query,search:this.search}})}}},O=s(1241);const V=(0,O.A)(K,[["render",I],["__scopeId","data-v-1befa0bc"]]);var Z=V}}]);